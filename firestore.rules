rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSystemAdmin() {
      return request.auth.token.role == 'system-admin';
    }

    function isUserAuthenticated() {
      return request.auth != null;
    }

    function isRequestingUser(userId) {
      return request.auth.uid == userId;
    }
    
    function isFromSchool(schoolId) {
      return request.auth.token.schoolId == schoolId;
    }

    // Default deny all reads and writes unless specified below
    match /{document=**} {
      allow read, update, delete: if false;
      allow create: if isUserAuthenticated();
    }
    
    // Test collection for connection check
    match /test_connection/{docId} {
        allow read, write, create: if isUserAuthenticated();
    }
    
    // User data is private
    match /users/{userId} {
      allow read, write: if isRequestingUser(userId) || isSystemAdmin();
    }

    // Schools can be read by anyone, but only managed by admins
    match /schools/{schoolId} {
      allow read: if true;
      allow write: if isSystemAdmin();
    }
    
    // Staff, Counselling, Disciplinary, OHS records are school-specific
    match /staff/{staffId} {
        allow read: if isFromSchool(resource.data.schoolId) || isSystemAdmin();
        allow write: if isFromSchool(request.resource.data.schoolId) || isSystemAdmin();
    }
    
    match /counselling/{recordId} {
        allow read, write: if isFromSchool(resource.data.schoolId) || isSystemAdmin();
        allow create: if isFromSchool(request.resource.data.schoolId) || isSystemAdmin();
    }
    
    match /disciplinary/{recordId} {
        allow read, write: if isFromSchool(resource.data.schoolId) || isSystemAdmin();
        allow create: if isFromSchool(request.resource.data.schoolId) || isSystemAdmin();
    }
    
    match /ohs/{recordId} {
        allow read, write: if isFromSchool(resource.data.schoolId) || isSystemAdmin();
        allow create: if isFromSchool(request.resource.data.schoolId) || isSystemAdmin();
    }
    
    // Library and exam data are school-specific
    match /books/{bookId} {
      allow read: if true;
      allow write: if isFromSchool(request.resource.data.schoolId) || isSystemAdmin();
    }
    
    match /transactions/{txId} {
      allow read, write: if isFromSchool(resource.data.schoolId) || isSystemAdmin();
      allow create: if isFromSchool(request.resource.data.schoolId) || isSystemAdmin();
    }

    match /examResults/{resultId} {
      allow read, write: if isFromSchool(resource.data.schoolId) || isSystemAdmin();
      allow create: if isFromSchool(request.resource.data.schoolId) || isSystemAdmin();
    }
  }
}
